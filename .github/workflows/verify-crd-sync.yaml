name: Verify CRD Sync

on:
  pull_request:
    branches: [main]
    paths:
      - 'pkg/apis/**'
      - 'config/crd/**'
      - 'charts/mcp-gateway/crds/**'
  push:
    branches: [main]
    paths:
      - 'pkg/apis/**'
      - 'config/crd/**'
      - 'charts/mcp-gateway/crds/**'
  workflow_dispatch:

concurrency:
  group: crd-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify-crd-sync:
    runs-on: ubuntu-latest
    name: Verify CRDs are synchronized
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Install controller-gen
      run: |
        go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest

    - name: Generate CRDs
      run: |
        make generate-crds

    - name: Check if Helm CRDs exist
      run: |
        if [ ! -d "charts/mcp-gateway/crds" ]; then
          echo "❌ Helm CRDs directory doesn't exist"
          echo "Run 'make update-helm-crds' to create and sync CRDs"
          exit 1
        fi

    - name: Verify CRDs are in sync
      run: make check-crd-sync

    - name: Verify Helm chart can be templated
      run: |
        # Install Helm
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        
        # Test that the chart templates correctly with current CRDs
        helm template test charts/mcp-gateway --debug >/dev/null
        echo "✅ Helm chart templates successfully with current CRDs"

    - name: Generate sync instructions on failure
      if: failure()
      run: |
        echo "## CRD Synchronization Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The CRDs in \`config/crd/\` and \`charts/mcp-gateway/crds/\` are out of sync." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### To fix this issue:" >> $GITHUB_STEP_SUMMARY
        echo "1. If you modified Go types, run:" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "   make generate-crds-all" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "2. If you only need to sync existing CRDs:" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "   make update-helm-crds" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "3. Commit the updated files and push again" >> $GITHUB_STEP_SUMMARY
