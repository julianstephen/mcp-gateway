apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: keycloak-preflight-204
  namespace: gateway-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: HTTP_ROUTE
    match:
      context: GATEWAY
      routeConfiguration:
        vhost:
          name: "keycloak.127-0-0-1.sslip.io:8889"
    patch:
      operation: INSERT_FIRST
      value:
        name: kc-preflight-clients-registrations
        match:
          path: "/realms/mcp/clients-registrations/openid-connect"
          headers:
          - name: ":method"
            exact_match: "OPTIONS"
        direct_response:
          status: 204
        response_headers_to_add:
        - header: { key: access-control-allow-origin,      value: "%REQ(ORIGIN)%" }
        - header: { key: access-control-allow-methods,     value: "POST, OPTIONS" }
        - header: { key: access-control-allow-headers,     value: "Content-Type, Authorization" }
        - header: { key: access-control-allow-credentials, value: "true" }
        - header: { key: vary,                              value: "Origin" }
        - header: { key: content-length,                    value: "0" }
